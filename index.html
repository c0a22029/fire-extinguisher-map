<!DOCTYPE html>
<html>
  <head>
    <title>æ¶ˆç«å™¨ãƒãƒƒãƒ—</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="è¿‘ãã®æ¶ˆç«å™¨ã‚’æ¤œç´¢ã—ã¦ãƒ«ãƒ¼ãƒˆæ¡ˆå†…ã™ã‚‹ã‚¢ãƒ—ãƒª">
    <meta name="theme-color" content="#ff4444">
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ¶ˆç«å™¨ãƒãƒƒãƒ—">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: 'Helvetica Neue', Arial, sans-serif;
        overscroll-behavior: none;
      }
      #map {
        height: 100%;
        width: 100%;
      }
      
      .control-panel {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 999;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .control-btn {
        padding: 8px 12px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        transition: all 0.2s ease;
        white-space: nowrap;
      }
      
      .control-btn:hover {
        background: #f8f9fa;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        transform: translateY(-1px);
      }
      
      .control-btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      }
      
      .info-panel {
        position: absolute;
        bottom: 20px;
        left: 20px;
        right: 20px;
        z-index: 999;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        padding: 15px;
        max-height: 200px;
        overflow-y: auto;
        transform: translateY(100%);
        transition: transform 0.3s ease;
      }
      
      .info-panel.show {
        transform: translateY(0);
      }
      
      .info-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
      }
      
      .info-title {
        font-weight: bold;
        color: #333;
        font-size: 16px;
      }
      
      .close-btn {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: #999;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
      }
      
      .close-btn:hover {
        background: #f0f0f0;
        color: #666;
      }
      
      .info-content {
        font-size: 14px;
        color: #666;
        line-height: 1.4;
      }
      
      .info-stats {
        display: flex;
        gap: 20px;
        margin-top: 10px;
      }
      
      .stat-item {
        text-align: center;
      }
      
      .stat-number {
        font-size: 20px;
        font-weight: bold;
        color: #ff4444;
      }
      
      .stat-label {
        font-size: 12px;
        color: #888;
      }
      
      .loading-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        background: white;
        padding: 20px 30px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        display: none;
      }
      
      .loading-overlay.show {
        display: block;
      }
      
      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #ff4444;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      #install-btn {
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 999;
        padding: 12px 20px;
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        box-shadow: 0 4px 15px rgba(255,68,68,0.3);
        cursor: pointer;
        display: none;
      }
      
      #install-btn.show {
        display: block;
      }
      
      @media (max-width: 768px) {
        .control-panel {
          top: 5px;
          left: 5px;
          right: 5px;
          flex-direction: row;
          flex-wrap: wrap;
          justify-content: space-between;
        }
        
        .control-btn {
          flex: 1;
          min-width: 80px;
          margin: 2px;
          font-size: 12px;
          padding: 6px 8px;
        }
        
        .info-panel {
          bottom: 10px;
          left: 10px;
          right: 10px;
          padding: 12px;
          max-height: 180px;
        }
        
        .info-stats {
          gap: 15px;
        }
        
        .stat-number {
          font-size: 18px;
        }
        
        #install-btn {
          bottom: 10px;
          right: 10px;
          padding: 10px 16px;
          font-size: 14px;
        }
      }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  </head>
  <body>
    <div id="map"></div>
    
    <div class="control-panel">
      <button id="recenter" class="control-btn">ç¾åœ¨åœ°ã«æˆ»ã‚‹</button>
      <button id="toggle-extinguishers" class="control-btn">æ¶ˆç«å™¨ã‚’éè¡¨ç¤º</button>
      <button id="show-info" class="control-btn">æƒ…å ±è¡¨ç¤º</button>
      <button id="find-nearest" class="control-btn" style="background: #ff4444; color: white; font-weight: bold;">ğŸ” æœ€å¯„ã‚Šæ¤œç´¢</button>
      <button id="find-all" class="control-btn" style="background: #4CAF50; color: white;">ğŸŒ å…¨åŸŸæ¤œç´¢</button>
    </div>
    
    <div id="loading" class="loading-overlay">
      <div class="spinner"></div>
      <span id="loading-text">æ¶ˆç«å™¨ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</span>
    </div>
    
    <button id="install-btn">ğŸ“± ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ </button>
    
    <div id="info-panel" class="info-panel">
      <div class="info-header">
        <div class="info-title">ğŸ“Š æ¶ˆç«å™¨ãƒãƒƒãƒ—æƒ…å ±</div>
        <button id="close-info" class="close-btn">Ã—</button>
      </div>
      <div class="info-content">
        <div class="info-stats">
          <div class="stat-item">
            <div class="stat-number" id="total-extinguishers">0</div>
            <div class="stat-label">æ¶ˆç«å™¨ç·æ•°</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="visible-markers">0</div>
            <div class="stat-label">è¡¨ç¤ºä¸­</div>
          </div>
          <div class="stat-item">
            <div class="stat-number" id="nearest-distance">-</div>
            <div class="stat-label">æœ€å¯„ã‚Š(m)</div>
          </div>
        </div>
        <div id="current-status">ç¾åœ¨åœ°ã‚’å–å¾—ä¸­...</div>
        <div id="nearest-info">ä½ç½®æƒ…å ±ãŒå¿…è¦ã§ã™</div>
      </div>
    </div>

    <script>
      let deferredPrompt;
      const installBtn = document.getElementById('install-btn');
      
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBtn.classList.add('show');
      });
      
      installBtn.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çµæœ: ${outcome}`);
        deferredPrompt = null;
        installBtn.classList.remove('show');
      });
      
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('âœ… Service Workerç™»éŒ²æˆåŠŸ'))
            .catch(err => console.log('âŒ Service Workerç™»éŒ²å¤±æ•—:', err));
        });
      }

      let map;
      let userMarker;
      let currentPos = null;
      let watchId = null;
      let firstUpdate = true;
      let mapInitialized = false;
      let extinguisherMarkers = [];
      let currentRoute = null;
      let routeVisible = false;
      let directionsService;
      let directionsRenderer;

      // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: trueã«ã™ã‚‹ã¨æŒ‡å®šä½æ‰€ã‚’ç¾åœ¨åœ°ã¨ã—ã¦ä½¿ç”¨
      const TEST_MODE = true;
      const TEST_LOCATION = { lat: 35.6045532, lng: 139.3301673 }; // æ±äº¬éƒ½ä¸­é‡åŒºå¤§å’Œç”º1ä¸ç›®6-2

      const DISTRICT_CONFIG = {
        nakano: {
          name: 'ä¸­é‡åŒº',
          file: 'nakanoku.csv',
          columns: { lat: 'ç·¯åº¦', lng: 'çµŒåº¦', address: 'ä½æ‰€', count: 'è¨­ç½®æœ¬æ•°', id: 'ç®¡ç†ç•ªå·', status: 'è¨­ç½®çŠ¶æ³' },
          filter: (row) => row['è¨­ç½®çŠ¶æ³'] === 'è¨­ç½®ä¸­'
        },
        machida: {
          name: 'ç”ºç”°å¸‚',
          file: 'machidasi.csv',
          columns: { lat: 'ç·¯åº¦', lng: 'çµŒåº¦', address: 'ä½æ‰€', count: null, id: 'æ¶ˆç«å™¨ç•ªå·' }
        },
        taito: {
          name: 'å°æ±åŒº',
          file: 'taitouku.csv',
          columns: { lat: 'ç·¯åº¦', lng: 'çµŒåº¦', address: 'æ‰€åœ¨', count: null, id: 'ç®¡ç†ç•ªå·' }
        },
        setagaya: {
          name: 'ä¸–ç”°è°·åŒº',
          file: 'setagayaku.csv',
          columns: { lat: 'ç·¯åº¦', lng: 'çµŒåº¦', address: 'ä½æ‰€', count: null, id: null }
        },
        fuchu: {
          name: 'åºœä¸­å¸‚',
          file: 'fuchusi.csv',
          columns: { lat: 'ç·¯åº¦', lng: 'çµŒåº¦', address: 'ä½æ‰€(ç”ºåã‹ã‚‰)', count: null, id: 'ç®¡ç†ç•ªå·' }
        }
      };

      function initMap() {
        if (mapInitialized) return;
        mapInitialized = true;
        
        const mapElement = document.getElementById("map");
        if (!mapElement) return;
        
        const fallback = { lat: 35.681236, lng: 139.767125 };
        
        map = new google.maps.Map(mapElement, {
          center: fallback,
          zoom: 16,
          mapTypeControl: false,
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
          map: map,
          suppressMarkers: true,
          polylineOptions: {
            strokeColor: '#2196F3',
            strokeOpacity: 0.8,
            strokeWeight: 5
          }
        });

        userMarker = new google.maps.Marker({
          position: fallback,
          map,
          title: "ç¾åœ¨åœ°ï¼ˆå–å¾—ä¸­â€¦ï¼‰",
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: "#4285F4",
            fillOpacity: 1,
            strokeColor: "white",
            strokeWeight: 3
          },
          zIndex: 1000
        });

        // â˜…é‡è¦: ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å…ˆã«è¨­å®š
        document.getElementById("recenter").addEventListener("click", () => {
          if (currentPos) {
            map.setCenter(currentPos);
            map.setZoom(17);
          }
        });
        
        document.getElementById("toggle-extinguishers").addEventListener("click", toggleExtinguishers);
        document.getElementById("show-info").addEventListener("click", toggleInfoPanel);
        document.getElementById("close-info").addEventListener("click", hideInfoPanel);
        document.getElementById("find-nearest").addEventListener("click", findAndShowNearestExtinguisher);
        document.getElementById("find-all").addEventListener("click", findAndShowNearestFromAll);

        // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã¯æŒ‡å®šä½ç½®ã‚’ä½¿ç”¨
        if (TEST_MODE) {
          currentPos = TEST_LOCATION;
          userMarker.setPosition(currentPos);
          userMarker.setTitle("ç¾åœ¨åœ°ï¼ˆãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ä¸­é‡åŒºå¤§å’Œç”º1-6-2ï¼‰");
          map.setCenter(currentPos);
          map.setZoom(17);
          loadAllExtinguishers();
          return;
        }

        if (navigator.geolocation) {
          watchId = navigator.geolocation.watchPosition(
            (position) => {
              const newPos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };
              
              currentPos = newPos;
              userMarker.setPosition(currentPos);
              userMarker.setTitle("ç¾åœ¨åœ°");
              
              if (position.coords.heading !== null && position.coords.heading !== undefined && !isNaN(position.coords.heading)) {
                userMarker.setIcon({
                  path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                  scale: 5,
                  fillColor: "#4285F4",
                  fillOpacity: 1,
                  strokeColor: "white",
                  strokeWeight: 2,
                  rotation: position.coords.heading
                });
              } else {
                userMarker.setIcon({
                  path: google.maps.SymbolPath.CIRCLE,
                  scale: 8,
                  fillColor: "#4285F4",
                  fillOpacity: 1,
                  strokeColor: "white",
                  strokeWeight: 3
                });
              }

              if (firstUpdate) {
                map.setCenter(currentPos);
                firstUpdate = false;
                loadAllExtinguishers();
              }
            },
            (error) => {
              console.error("ç¾åœ¨åœ°å–å¾—ã«å¤±æ•—:", error);
              loadAllExtinguishers();
            },
            { 
              enableHighAccuracy: true, 
              maximumAge: 0, 
              timeout: 5000
            }
          );
        } else {
          loadAllExtinguishers();
        }
      }

      async function loadAllExtinguishers() {
        try {
          showLoading(true, 'æ¶ˆç«å™¨ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');
          clearExtinguisherMarkers();
          
          let totalCount = 0;
          const loadPromises = [];
          
          for (const [key, config] of Object.entries(DISTRICT_CONFIG)) {
            loadPromises.push(loadDistrictCSV(key, config));
          }
          
          const results = await Promise.allSettled(loadPromises);
          
          results.forEach((result, index) => {
            const districtName = Object.values(DISTRICT_CONFIG)[index].name;
            if (result.status === 'fulfilled') {
              totalCount += result.value;
            }
          });
          
          showLoading(false);
          updateStats();
          updateCurrentStatus(`${Object.keys(DISTRICT_CONFIG).length}è‡ªæ²»ä½“ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†ï¼ˆ${totalCount}ä»¶ï¼‰`);
          
          if (currentPos) {
            findNearestExtinguisher();
          }
        } catch (err) {
          showLoading(false);
          addDummyExtinguisher();
          updateCurrentStatus("ã‚¨ãƒ©ãƒ¼: ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã§å‹•ä½œä¸­");
        }
      }

      function loadDistrictCSV(districtKey, config) {
        return new Promise((resolve, reject) => {
          if (typeof Papa === 'undefined') {
            reject(new Error('PapaParseæœªèª­ã¿è¾¼ã¿'));
            return;
          }
          
          Papa.parse(config.file, {
            download: true,
            header: true,
            skipEmptyLines: true,
            encoding: 'UTF-8',
            complete: function(results) {
              let markerCount = 0;
              results.data.forEach((row, index) => {
                if (config.filter && !config.filter(row)) return;
                
                const lat = parseFloat(row[config.columns.lat]);
                const lng = parseFloat(row[config.columns.lng]);
                const address = row[config.columns.address] || 'ä½æ‰€ä¸æ˜';
                const managementNo = config.columns.id ? (row[config.columns.id] || `${districtKey}-${index}`) : `${districtKey}-${index}`;
                const count = config.columns.count ? (parseInt(row[config.columns.count]) || 1) : 1;
                
                if (!isNaN(lat) && !isNaN(lng)) {
                  createExtinguisherMarker(lat, lng, address, managementNo, count, config.name);
                  markerCount++;
                }
              });
              
              resolve(markerCount);
            },
            error: function(error) {
              reject(new Error(`CSVèª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}`));
            }
          });
        });
      }

      function createExtinguisherMarker(lat, lng, address, managementNo, count, districtName) {
        const marker = new google.maps.Marker({
          position: { lat, lng },
          map: map,
          title: `${districtName} - æ¶ˆç«å™¨ (${count}æœ¬) - ${address}`,
          icon: {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="32" height="32">
                <circle cx="16" cy="16" r="14" fill="#ff4444" stroke="white" stroke-width="2"/>
                <text x="16" y="20" text-anchor="middle" fill="white" font-family="Arial" font-size="12" font-weight="bold">${count}</text>
              </svg>
            `),
            scaledSize: new google.maps.Size(32, 32),
            anchor: new google.maps.Point(16, 16)
          },
        });
        
        const infoWindow = new google.maps.InfoWindow({
          content: createInfoWindowContent(managementNo, count, address, lat, lng, districtName)
        });
        
        marker.addListener('click', () => {
          infoWindow.open(map, marker);
        });
        
        marker.infoWindow = infoWindow;
        marker.districtName = districtName;
        extinguisherMarkers.push(marker);
      }

      function createInfoWindowContent(managementNo, count, address, lat, lng, districtName = '') {
        let distanceText = '';
        let walkingTimeText = '';
        
        if (currentPos) {
          const distance = calculateDistance(currentPos, { lat, lng });
          distanceText = `<p><strong>ç›´ç·šè·é›¢:</strong> ${distance.toFixed(0)}m</p>`;
          
          const walkingTime = Math.ceil(distance / 80);
          walkingTimeText = `<p><strong>å¾’æ­©:</strong> ç´„${walkingTime}åˆ†</p>`;
        }
        
        const districtLabel = districtName ? `<p><strong>è‡ªæ²»ä½“:</strong> ${districtName}</p>` : '';
        
        return `
          <div style="padding: 10px; max-width: 250px;">
            <h4 style="margin: 0 0 10px 0; color: #ff4444;">ğŸ§¯ è¡—é ­æ¶ˆç«å™¨</h4>
            ${districtLabel}
            <p><strong>ç®¡ç†ç•ªå·:</strong> ${managementNo}</p>
            <p><strong>è¨­ç½®æœ¬æ•°:</strong> ${count}æœ¬</p>
            <p><strong>ä½æ‰€:</strong> ${address}</p>
            ${distanceText}
            ${walkingTimeText}
            <p style="font-size: 12px; color: #666;">
              åº§æ¨™: ${lat.toFixed(6)}, ${lng.toFixed(6)}
            </p>
          </div>
        `;
      }

      function calculateDistance(pos1, pos2) {
        const R = 6371000;
        const dLat = (pos2.lat - pos1.lat) * Math.PI / 180;
        const dLng = (pos2.lng - pos1.lng) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(pos1.lat * Math.PI / 180) * Math.cos(pos2.lat * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }

      function clearRoute() {
        if (directionsRenderer) {
          directionsRenderer.setMap(null);
        }
        routeVisible = false;
      }

      async function findAndShowNearestExtinguisher() {
        const findNearestBtn = document.getElementById("find-nearest");
        
        if (routeVisible) {
          clearRoute();
          if (findNearestBtn) {
            findNearestBtn.textContent = "ğŸ” æœ€å¯„ã‚Šæ¤œç´¢";
            findNearestBtn.style.background = "#ff4444";
          }
          updateCurrentStatus("ãƒ«ãƒ¼ãƒˆã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ");
          return;
        }
        
        if (!currentPos) {
          updateCurrentStatus("âŒ ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“");
          return;
        }
        
        showLoading(true, 'é“è·¯è·é›¢ã§æœ€å¯„ã‚Šã‚’æ¤œç´¢ä¸­...');
        
        const nearest = await findNearestByRoadDistance(240);
        
        showLoading(false);
        
        if (!nearest) {
          updateCurrentStatus("âŒ 240mä»¥å†…ã«æ¶ˆç«å™¨ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          alert('âš ï¸ 240mä»¥å†…ã«æ¶ˆç«å™¨ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        directionsRenderer.setMap(map);
        directionsRenderer.setDirections(nearest.directions);
        routeVisible = true;
        
        if (nearest.marker.infoWindow) {
          nearest.marker.infoWindow.open(map, nearest.marker);
        }
        
        updateCurrentStatus(`âœ… ãƒ«ãƒ¼ãƒˆè¡¨ç¤º: ${nearest.distance.toFixed(0)}må…ˆï¼ˆ${nearest.duration}ï¼‰`);
        updateNearestInfo(nearest.marker.getTitle(), nearest.distance);
        
        if (findNearestBtn) {
          findNearestBtn.textContent = "âŒ ãƒ«ãƒ¼ãƒˆéè¡¨ç¤º";
        }
      }

      async function findNearestByRoadDistance(maxDistance = null) {
        if (!currentPos || extinguisherMarkers.length === 0) return null;
        
        const searchRadius = 0.004;
        const bbox = {
          north: currentPos.lat + searchRadius,
          south: currentPos.lat - searchRadius,
          east: currentPos.lng + searchRadius,
          west: currentPos.lng - searchRadius
        };
        
        let candidates = extinguisherMarkers.filter(marker => {
          if (marker.getMap() === null) return false;
          
          const markerPos = marker.getPosition();
          const lat = markerPos.lat();
          const lng = markerPos.lng();
          
          return lat >= bbox.south && lat <= bbox.north &&
                 lng >= bbox.west && lng <= bbox.east;
        });
        
        if (candidates.length === 0) {
          return null;
        }
        
        candidates = candidates.map(marker => {
          const markerPos = marker.getPosition();
          const straightDistance = calculateDistance(currentPos, {
            lat: markerPos.lat(),
            lng: markerPos.lng()
          });
          return { marker, straightDistance };
        });
        
        candidates.sort((a, b) => a.straightDistance - b.straightDistance);
        
        const top3 = candidates.slice(0, 3);
        
        const results = [];
        
        for (const candidate of top3) {
          const markerPos = candidate.marker.getPosition();
          const request = {
            origin: currentPos,
            destination: { lat: markerPos.lat(), lng: markerPos.lng() },
            travelMode: google.maps.TravelMode.WALKING
          };
          
          try {
            const result = await new Promise((resolve, reject) => {
              directionsService.route(request, (result, status) => {
                if (status === 'OK') {
                  resolve(result);
                } else {
                  reject(new Error(status));
                }
              });
            });
            
            const leg = result.routes[0].legs[0];
            const roadDistance = leg.distance.value;
            
            if (maxDistance === null || roadDistance <= maxDistance) {
              results.push({
                marker: candidate.marker,
                distance: roadDistance,
                duration: leg.duration.text,
                directions: result
              });
            }
          } catch (error) {
            console.warn('Directions APIå¤±æ•—:', error);
          }
        }
        
        if (results.length === 0) {
          return null;
        }
        
        results.sort((a, b) => a.distance - b.distance);
        
        return results[0];
      }

      async function findAndShowNearestFromAll() {
        const findAllBtn = document.getElementById("find-all");
        
        if (routeVisible) {
          clearRoute();
          if (findAllBtn) {
            findAllBtn.textContent = "ğŸŒ å…¨åŸŸæ¤œç´¢";
            findAllBtn.style.background = "#4CAF50";
          }
          updateCurrentStatus("ãƒ«ãƒ¼ãƒˆã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ");
          return;
        }
        
        if (!currentPos) {
          updateCurrentStatus("âŒ ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“");
          return;
        }
        
        showLoading(true, 'å…¨åŸŸã‹ã‚‰æœ€å¯„ã‚Šã‚’æ¤œç´¢ä¸­...');
        
        const nearest = await findNearestByRoadDistance(null);
        
        showLoading(false);
        
        if (!nearest) {
          updateCurrentStatus("âŒ æ¶ˆç«å™¨ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“");
          return;
        }
        
        directionsRenderer.setMap(map);
        directionsRenderer.setDirections(nearest.directions);
        routeVisible = true;
        
        if (nearest.marker.infoWindow) {
          nearest.marker.infoWindow.open(map, nearest.marker);
        }
        
        updateCurrentStatus(`âœ… å…¨åŸŸæ¤œç´¢: ${nearest.distance.toFixed(0)}må…ˆï¼ˆ${nearest.duration}ï¼‰- ${nearest.marker.districtName}`);
        updateNearestInfo(nearest.marker.getTitle(), nearest.distance);
        
        if (findAllBtn) {
          findAllBtn.textContent = "âŒ ãƒ«ãƒ¼ãƒˆéè¡¨ç¤º";
          findAllBtn.style.background = "#f44336";
        }
      }

      function findNearestExtinguisher() {
        if (!currentPos || extinguisherMarkers.length === 0) return null;
        
        const searchRadius = 0.02;
        const bbox = {
          north: currentPos.lat + searchRadius,
          south: currentPos.lat - searchRadius,
          east: currentPos.lng + searchRadius,
          west: currentPos.lng - searchRadius
        };
        
        const candidates = extinguisherMarkers.filter(marker => {
          if (marker.getMap() === null) return false;
          
          const markerPos = marker.getPosition();
          const lat = markerPos.lat();
          const lng = markerPos.lng();
          
          return lat >= bbox.south && lat <= bbox.north &&
                 lng >= bbox.west && lng <= bbox.east;
        });
        
        if (candidates.length === 0) {
          return findNearestFromAll();
        }
        
        let minDistance = Infinity;
        let nearestMarker = null;
        
      candidates.forEach(marker => {
          const markerPos = marker.getPosition();
          const distance = calculateDistance(currentPos, {
            lat: markerPos.lat(),
            lng: markerPos.lng()
          });
          
          if (distance < minDistance) {
            minDistance = distance;
            nearestMarker = marker;
          }
        });
        
        if (nearestMarker) {
          updateNearestInfo(nearestMarker.getTitle(), minDistance);
          
          return {
            marker: nearestMarker,
            distance: minDistance,
            infoWindow: nearestMarker.infoWindow
          };
        }
        
        return null;
      }

      function findNearestFromAll() {
        if (!currentPos || extinguisherMarkers.length === 0) return null;
        
        let minDistance = Infinity;
        let nearestMarker = null;
        
        extinguisherMarkers.forEach(marker => {
          if (marker.getMap() === null) return;
          
          const markerPos = marker.getPosition();
          const distance = calculateDistance(currentPos, {
            lat: markerPos.lat(),
            lng: markerPos.lng()
          });
          
          if (distance < minDistance) {
            minDistance = distance;
            nearestMarker = marker;
          }
        });
        
        if (nearestMarker) {
          updateNearestInfo(nearestMarker.getTitle(), minDistance);
          
          return {
            marker: nearestMarker,
            distance: minDistance,
            infoWindow: nearestMarker.infoWindow
          };
        }
        
        return null;
      }

      function toggleExtinguishers() {
        const isVisible = extinguisherMarkers.length > 0 && extinguisherMarkers[0].getMap() !== null;
        
        extinguisherMarkers.forEach(marker => {
          marker.setMap(isVisible ? null : map);
        });
        
        const toggleBtn = document.getElementById("toggle-extinguishers");
        if (toggleBtn) {
          toggleBtn.textContent = isVisible ? "ğŸ§¯ æ¶ˆç«å™¨ã‚’è¡¨ç¤º" : "ğŸ§¯ æ¶ˆç«å™¨ã‚’éè¡¨ç¤º";
        }
        
        updateStats();
      }

      function clearExtinguisherMarkers() {
        extinguisherMarkers.forEach(marker => {
          marker.setMap(null);
        });
        extinguisherMarkers = [];
      }

      function addDummyExtinguisher() {
        const dummyData = [
          { lat: 35.681500, lng: 139.767200, district: 'ä¸­é‡åŒº(ãƒ†ã‚¹ãƒˆ)' },
          { lat: 35.681600, lng: 139.767300, district: 'ç”ºç”°å¸‚(ãƒ†ã‚¹ãƒˆ)' },
          { lat: 35.681700, lng: 139.767400, district: 'å°æ±åŒº(ãƒ†ã‚¹ãƒˆ)' },
          { lat: 35.681800, lng: 139.767500, district: 'ä¸–ç”°è°·åŒº(ãƒ†ã‚¹ãƒˆ)' },
          { lat: 35.681900, lng: 139.767600, district: 'åºœä¸­å¸‚(ãƒ†ã‚¹ãƒˆ)' }
        ];
        
        dummyData.forEach((data, index) => {
          const marker = new google.maps.Marker({
            position: { lat: data.lat, lng: data.lng },
            map: map,
            title: `${data.district} - ãƒ†ã‚¹ãƒˆç”¨æ¶ˆç«å™¨ (1æœ¬)`,
            icon: {
              url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="32" height="32">
                  <circle cx="16" cy="16" r="14" fill="#ff4444" stroke="white" stroke-width="2"/>
                  <text x="16" y="20" text-anchor="middle" fill="white" font-family="Arial" font-size="12" font-weight="bold">1</text>
                </svg>
              `),
              scaledSize: new google.maps.Size(32, 32),
              anchor: new google.maps.Point(16, 16)
            }
          });
          
          const infoWindow = new google.maps.InfoWindow({
            content: createInfoWindowContent(`TEST-${index + 1}`, 1, `æ±äº¬é§…å‘¨è¾ºï¼ˆ${data.district}ï¼‰`, data.lat, data.lng, data.district)
          });
          
          marker.addListener('click', () => {
            infoWindow.open(map, marker);
          });
          
          marker.infoWindow = infoWindow;
          marker.districtName = data.district;
          extinguisherMarkers.push(marker);
        });
        
        updateStats();
      }

      function showLoading(show, text = 'æ¶ˆç«å™¨ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...') {
        const loadingElement = document.getElementById('loading');
        const loadingTextElement = document.getElementById('loading-text');
        if (loadingElement) {
          loadingElement.classList.toggle('show', show);
        }
        if (loadingTextElement && show) {
          loadingTextElement.textContent = text;
        }
      }

      function toggleInfoPanel() {
        const panel = document.getElementById('info-panel');
        if (panel) {
          panel.classList.toggle('show');
          updateStats();
        }
      }

      function hideInfoPanel() {
        const panel = document.getElementById('info-panel');
        if (panel) {
          panel.classList.remove('show');
        }
      }

      function updateStats() {
        const totalElement = document.getElementById('total-extinguishers');
        const visibleElement = document.getElementById('visible-markers');
        
        if (totalElement) {
          totalElement.textContent = extinguisherMarkers.length;
        }
        
        if (visibleElement) {
          const visibleCount = extinguisherMarkers.filter(marker => marker.getMap() !== null).length;
          visibleElement.textContent = visibleCount;
        }
      }

      function updateCurrentStatus(status) {
        const statusElement = document.getElementById('current-status');
        if (statusElement) {
          statusElement.textContent = status;
        }
      }

      function updateNearestInfo(title, distance) {
        const nearestElement = document.getElementById('nearest-info');
        const distanceElement = document.getElementById('nearest-distance');
        
        if (nearestElement) {
          nearestElement.textContent = `æœ€å¯„ã‚Š: ${title}`;
        }
        
        if (distanceElement) {
          distanceElement.textContent = distance.toFixed(0);
        }
      }
    </script>

    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCCpSKIHVdZK4WG9nhJ1N403npfcaFh860&callback=initMap"
      async
      defer
    ></script>
  </body>
</html>